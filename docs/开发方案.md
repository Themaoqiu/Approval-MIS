我将为你制定一个完整的审批系统开发方案。首先让我分析需求文档，然后给出详细的技术方案和团队分工。

## 审批系统开发方案

### 一、技术栈架构

**前端框架：**
- Next.js 15+ (App Router) - 处理页面路由和 SSR
- TypeScript + TSX
- TailwindCSS + shadcn/ui
- TanStack Query (数据获取和缓存)
- TanStack Table (表格)
- Zustand (轻量状态管理)
- Zod (数据验证)

**后端框架：**
- Hono (API 路由) - 在 Next.js API Routes 中运行
- Better-Auth (认证方案)
- Prisma (ORM)
- PostgreSQL (数据库)

**运行时：**
- Bun 

**架构说明：**
```
前端请求 → Next.js App Router (app/xxx/page.tsx)
         ↓
    TanStack Query (fetch)
         ↓
    Next.js API Routes (app/api/[...route]/route.ts)
         ↓
    Hono App (处理 RESTful API 逻辑)
         ↓
    Prisma → PostgreSQL
```

**为什么这样设计：**
- Next.js App Router 负责页面路由和 UI 渲染
- Hono 在 Next.js API Routes 中运行，提供类型安全的 API
- Better-Auth 简化认证，无需手动管理 JWT
- TanStack Query 处理客户端数据获取和缓存

### 二、项目初始化命令

```bash
# 1. 创建 Next.js 项目（使用 bun）
bunx create-next-app@latest approval-mis --typescript --tailwind --app --no-src-dir

cd approval-mis

# 2. 安装核心依赖
bun add @tanstack/react-query @tanstack/react-table zustand zod
bun add hono better-auth
bun add prisma @prisma/client
bun add date-fns clsx class-variance-authority
bun add react-hook-form @hookform/resolvers

# 3. 安装 shadcn/ui
bunx shadcn@latest init

# 4. 添加常用 shadcn 组件
bunx shadcn@latest add button input label card table dropdown-menu dialog form select textarea badge avatar sonner tabs accordion calendar popover command

# 5. 安装动态表单相关（选做功能）
bun add @hello-pangea/dnd

# 6. 安装流程设计器（选做功能）
bun add reactflow

# 7. 安装图表库（统计功能）
bun add recharts

# 8. 安装文件上传
bun add uploadthing @uploadthing/react

# 9. 初始化 Prisma
bunx prisma init

# 10. 安装开发依赖
bun add -D @types/node

# 11. 配置数据库连接（编辑 .env 文件）
# DATABASE_URL="postgresql://user:password@localhost:5432/approval_mis"
```

### 三、文件组织结构（简洁实用版）

**架构原则说明：**
- `app/` - Next.js App Router（页面路由 + API Routes）
- `components/` - 所有 UI 组件（按功能分组）
- `lib/` - 工具函数、Prisma Client、配置（轻量级）
- `prisma/` - 数据库 schema 和迁移

```
approval-mis/
├── app/
│   ├── (auth)/
│   │   ├── login/
│   │   │   └── page.tsx
│   │   └── layout.tsx
│   │
│   ├── (dashboard)/
│   │   ├── layout.tsx              # 侧边栏布局
│   │   ├── page.tsx                # 首页
│   │   ├── applications/           # 我的申请
│   │   │   ├── page.tsx
│   │   │   ├── new/page.tsx
│   │   │   └── [id]/page.tsx
│   │   ├── tasks/                  # 我的待办
│   │   │   ├── page.tsx
│   │   │   └── [id]/page.tsx
│   │   ├── approvals/              # 我已处理
│   │   │   └── page.tsx
│   │   ├── admin/
│   │   │   ├── users/page.tsx
│   │   │   ├── departments/page.tsx
│   │   │   └── posts/page.tsx
│   │   └── statistics/             # 统计（选做）
│   │       └── page.tsx
│   │
│   ├── api/
│   │   └── [...route]/
│   │       └── route.ts            # Hono API（所有 RESTful 路由）
│   │
│   ├── layout.tsx
│   └── page.tsx
│
├── components/
│   ├── ui/                         # shadcn/ui 基础组件
│   │   ├── button.tsx
│   │   ├── input.tsx
│   │   ├── dialog.tsx
│   │   └── ...
│   │
│   ├── layout/                     # 布局组件
│   │   ├── sidebar.tsx
│   │   ├── header.tsx
│   │   └── nav.tsx
│   │
│   ├── applications/               # 申请相关组件
│   │   ├── application-form.tsx
│   │   ├── application-list.tsx
│   │   ├── application-detail.tsx
│   │   ├── leave-form.tsx
│   │   └── expense-form.tsx
│   │
│   ├── approvals/                  # 审批相关组件
│   │   ├── approval-dialog.tsx
│   │   ├── approval-timeline.tsx
│   │   └── task-card.tsx
│   │
│   ├── admin/                      # 管理功能组件
│   │   ├── user-table.tsx
│   │   ├── user-form.tsx
│   │   ├── dept-tree.tsx
│   │   └── post-table.tsx
│   │
│   ├── form-builder/               # 动态表单设计器（选做）
│   │   ├── field-library.tsx
│   │   ├── canvas.tsx
│   │   ├── property-panel.tsx
│   │   ├── preview.tsx
│   │   └── form-renderer.tsx      # 表单渲染引擎
│   │
│   ├── process-builder/            # 流程设计器（选做）
│   │   ├── node-types.tsx
│   │   ├── edge-types.tsx
│   │   ├── toolbar.tsx
│   │   ├── config-panel.tsx
│   │   └── process-engine.tsx     # 流程引擎
│   │
│   ├── statistics/                 # 统计报表（选做）
│   │   ├── stat-card.tsx
│   │   ├── charts.tsx
│   │   └── dashboard.tsx
│   │
│   └── shared/                     # 通用业务组件
│       ├── data-table.tsx
│       ├── status-badge.tsx
│       ├── file-upload.tsx
│       └── date-picker.tsx
│
├── lib/
│   ├── prisma.ts                   # Prisma Client 单例（就这一个文件）
│   ├── auth.ts                     # Better-Auth 配置
│   ├── api.ts                      # Hono app 定义（所有 API 路由）
│   ├── uploadthing.ts              # 文件上传配置（选做）
│   └── utils.ts                    # 通用工具（cn, formatDate 等）
│
├── hooks/                          # 全局 React Hooks
│   ├── use-auth.ts
│   ├── use-applications.ts
│   ├── use-approvals.ts
│   ├── use-users.ts
│   ├── use-form-builder.ts         # 动态表单（选做）
│   ├── use-process-builder.ts      # 流程设计器（选做）
│   └── use-statistics.ts           # 统计（选做）
│
├── types/                          # TypeScript 类型
│   └── index.ts                    # 所有类型定义
│
├── prisma/
│   ├── schema.prisma
│   ├── migrations/
│   └── seed.ts
│
├── public/
├── .env
├── next.config.ts
├── tailwind.config.ts
├── tsconfig.json
└── package.json
```

### 五、渐进式开发顺序（两周完成所有功能）

#### **第 1-2 天：基础架构 + 认证系统**

**我负责（核心架构）：**
1. ✅ 项目初始化（Next.js + Bun）
2. ✅ Prisma schema 设计和数据库迁移
3. ✅ Better-Auth 配置
   - 创建 `lib/auth.ts`
   - 配置认证 API (`app/api/auth/[...all]/route.ts`)
   - 实现登录/登出功能
4. ✅ Hono API 基础架构
   - 创建 `lib/api/index.ts` (Hono app 入口)
   - 创建 `app/api/[...route]/route.ts` (集成点)
   - 认证中间件集成 Better-Auth
5. ✅ 基础布局组件
   - `app/(dashboard)/layout.tsx` (侧边栏布局)
   - `components/layout/sidebar.tsx`
   - `components/layout/header.tsx`

**我负责（核心架构）：**
1. ✅ 项目初始化 + Prisma schema + 数据库迁移
2. ✅ Better-Auth 配置（快速集成，1小时搞定）
3. ✅ Hono API 基础架构 + 认证中间件
4. ✅ 基础布局组件（使用 shadcn 模板快速搭建）

**团队成员任务（并行）：**
- **成员A**：shadcn 组件集成 + 主题配置
- **成员B**：编写 seed.ts + README
- **成员C**：创建所有页面框架（空白页面）

**第1-2天结束：** 可以登录 + 看到完整布局

---

#### **第 3-4 天：申请管理（请假 + 报销）+ 文件上传**

**我负责：**
1. ✅ 申请 CRUD API（请假 + 报销共用接口）
2. ✅ 集成 uploadthing（发票附件上传）
3. ✅ 请假表单 + 申请列表页面

**团队成员任务（并行）：**
- **成员A**：报销表单组件
- **成员B**：申请详情页面 + 文件预览组件
- **成员C**：测试 + 边界情况处理

**第3-4天结束：** 可以创建申请 + 上传附件

---

#### **第 5-6 天：审批功能 + 多级流程**

**我负责：**
1. ✅ 审批 API（待办/已处理/同意/拒绝）
2. ✅ 简单流程引擎（支持多级审批）
3. ✅ 待办列表页面

**团队成员任务（并行）：**
- **成员A**：审批对话框 + 审批时间线组件
- **成员B**：已处理列表页面
- **成员C**：测试多级审批流转

**第5-6天结束：** 完整审批流程可用

---

#### **第 7-8 天：管理员功能 + 统计报表**

**我负责：**
1. ✅ 用户/部门/岗位管理 API
2. ✅ 统计 API（个人/部门统计）
3. ✅ 用户管理页面

**团队成员任务（并行）：**
- **成员A**：部门管理页面（树形结构，用 shadcn Accordion）
- **成员B**：统计页面（使用 recharts，简单图表）
- **成员C**：岗位管理页面

**第7-8天结束：** 管理功能 + 统计完成

---

#### **第 9-11 天：动态表单 + 动态流程（核心选做）**

**关键技术选型（节省时间）：**
- **动态表单**：使用 `react-hook-form` + `@dnd-kit/core`（拖拽）
- **流程设计器**：使用 `reactflow`（开源流程图库）

**我负责：**
1. ✅ 表单设计器数据结构 + 存储 API
2. ✅ 动态表单渲染引擎（根据 JSON 配置渲染）
3. ✅ 流程设计器数据结构 + 存储 API
4. ✅ 流程引擎升级（支持条件分支、会签/或签）

**团队成员任务（并行）：**
- **成员A**：表单设计器 UI（拖拽组件库）
  - 左侧字段库（文本、下拉、日期、文件等）
  - 中间画布区
  - 右侧属性编辑器
  
- **成员B**：流程设计器 UI（基于 React Flow）
  - 节点组件（审批节点、条件节点、会签节点）
  - 连线规则
  - 属性配置面板
  
- **成员C**：审批人选择器组件
  - 按岗位选择
  - 按部门选择
  - 指定具体人员

**第9-11天结束：** 动态表单 + 流程设计器可用

---

#### **第 12-13 天：集成测试 + 优化**

**全员任务：**
1. **功能测试**
   - 测试所有业务流程
   - 测试动态表单各种字段类型
   - 测试复杂审批流程（条件分支、会签）
   - 权限测试

2. **性能优化**
   - TanStack Query 缓存优化
   - 数据库查询优化（添加索引）
   - 前端代码分割

3. **UI/UX 优化**
   - 响应式适配
   - 加载动画
   - 错误提示优化

**第12-13天结束：** 系统稳定可用

---

#### **第 14 天：文档 + 演示准备**

**全员任务：**
1. 编写用户手册
2. 编写部署文档
3. 准备演示数据
4. 录制功能演示视频
5. 制作 PPT

**第14天结束：** 完整交付

### 六、关键代码示例

#### 1. Better-Auth 配置 (`lib/auth.ts`)

```typescript
import { betterAuth } from "better-auth"
import { prismaAdapter } from "better-auth/adapters/prisma"
import { prisma } from "./db/client"

export const auth = betterAuth({
  database: prismaAdapter(prisma, {
    provider: "postgresql"
  }),
  emailAndPassword: {
    enabled: true,
  },
  session: {
    cookieCache: {
      enabled: true,
      maxAge: 5 * 60, // 5 minutes
    },
  },
})
```

#### 2. Hono API 入口 (`lib/api/index.ts`)

```typescript
import { Hono } from 'hono'
import { handle } from 'hono/vercel'
import { applicationRoutes } from './routes/applications'
import { approvalRoutes } from './routes/approvals'
import { userRoutes } from './routes/users'
import { authMiddleware } from './middleware/auth'

const app = new Hono().basePath('/api')

// 需要认证的路由
app.use('/*', authMiddleware)
app.route('/applications', applicationRoutes)
app.route('/approvals', approvalRoutes)
app.route('/users', userRoutes)

export const GET = handle(app)
export const POST = handle(app)
export const PUT = handle(app)
export const PATCH = handle(app)
export const DELETE = handle(app)
```

#### 3. 认证中间件（集成 Better-Auth）

```typescript
import { Context, Next } from 'hono'
import { auth } from '@/lib/auth'

export async function authMiddleware(c: Context, next: Next) {
  const session = await auth.api.getSession({
    headers: c.req.raw.headers
  })
  
  if (!session) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  c.set('user', session.user)
  c.set('session', session)
  await next()
}
```

#### 4. TanStack Query Hook 示例

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'

export function useApplications() {
  return useQuery({
    queryKey: ['applications'],
    queryFn: async () => {
      const res = await fetch('/api/applications')
      return res.json()
    }
  })
}

export function useCreateApplication() {
  const queryClient = useQueryClient()
  
  return useMutation({
    mutationFn: async (data: any) => {
      const res = await fetch('/api/applications', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      return res.json()
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['applications'] })
    }
  })
}
```

### 七、环境配置

创建 `.env` 文件：

```env
# Database
DATABASE_URL="postgresql://user:password@localhost:5432/approval_mis"

# Better-Auth
BETTER_AUTH_SECRET="your-super-secret-key-change-this-in-production"
BETTER_AUTH_URL="http://localhost:3000"

# UploadThing（文件上传）
UPLOADTHING_SECRET="your-uploadthing-secret"
UPLOADTHING_APP_ID="your-uploadthing-app-id"
```

## 立即开始

**第一步（30分钟）：**
```bash
bunx create-next-app@latest approval-mis --typescript --tailwind --app --no-src-dir
cd approval-mis
bun add @tanstack/react-query @tanstack/react-table zustand zod hono better-auth prisma @prisma/client date-fns clsx class-variance-authority react-hook-form @hookform/resolvers @dnd-kit/core @dnd-kit/sortable reactflow recharts uploadthing @uploadthing/react
bunx shadcn@latest init
bunx prisma init
```

**第二步（1小时）：**
- 复制 Prisma schema
- 配置 .env
- 运行 `bunx prisma migrate dev`
- 创建基础文件结构

**第三步（2小时）：**
- 配置 Better-Auth
- 创建 Hono API 入口
- 创建基础布局


